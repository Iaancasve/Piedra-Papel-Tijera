<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Juego Node</title>

    <style>
        body {
            font-family: sans-serif;
            padding: 20px;
            background: #f4f4f4;
        }
        .hidden { display: none; }
        .box {
            background: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        button {
            padding: 8px 15px;
            margin: 5px;
            cursor: pointer;
        }
        .game-item {
            border-bottom: 1px solid #ddd;
            padding: 5px;
            display: flex;
            justify-content: space-between;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: center;
        }
    </style>

    <script src="/socket.io/socket.io.js"></script>
</head>
<body>

<div id="auth-screen" class="box">
    <h2>Login</h2>
    <input id="u" placeholder="User">
    <input id="p" type="password" placeholder="Pass">
    <br>
    <button onclick="auth('login')">Entrar</button>
    <button onclick="auth('register')">Registro</button>
</div>

<div id="lobby-screen" class="hidden box">
    <h2>
        Lobby - Hola <span id="display-user"></span>
        <button onclick="logout()">Salir</button>
    </h2>

    <button onclick="emit('crear_partida','cpu')">Vs CPU</button>
    <button onclick="emit('crear_partida','humano')">Vs Humano</button>

    <h3>Partidas disponibles</h3>
    <div id="lista-partidas"></div>

    <h3>üèÜ Ranking Top 10</h3>
    <table>
        <thead>
            <tr>
                <th>User</th>
                <th>% Wins</th>
                <th>W/T</th>
            </tr>
        </thead>
        <tbody id="ranking-body"></tbody>
    </table>
</div>

<div id="game-screen" class="hidden box" style="text-align:center;">
    <h2>En partida (<span id="oponente-name"></span>)</h2>

    <div style="font-size:20px;">
        YO: <b id="score-me">0</b> -
        RIVAL: <b id="score-rival">0</b>
    </div>

    <div id="zona-juego">
        <br>
        <button onclick="emit('jugada','piedra')">ü™®</button>
        <button onclick="emit('jugada','papel')">üìÑ</button>
        <button onclick="emit('jugada','tijera')">‚úÇÔ∏è</button>
    </div>

    <p id="status-msg" style="color:blue;font-weight:bold;"></p>

    <div id="fin-msg" class="hidden">
        <h3>FIN DE PARTIDA</h3>
        <button onclick="location.reload()">Volver</button>
    </div>

    <br>
    <button
        style="background:red;color:white"
        onclick="if(confirm('¬øSalir?')) emit('abandonar_partida')"
    >
        Abandonar
    </button>
</div>

<script>
let socket;
let token = localStorage.getItem('token');
let uid = localStorage.getItem('uid');
let p1Id = null;

/* Esperar a que el DOM est√© listo */
window.onload = () => {
    if (token) {
        show('lobby-screen');
        document.getElementById('display-user').innerText =
            localStorage.getItem('user');
        connect();
    }
};

async function auth(type) {
    const u = document.getElementById('u').value;
    const p = document.getElementById('p').value;

    const res = await fetch(`/api/auth/${type}`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ username: u, password: p })
    });

    const data = await res.json();

    if (res.ok && type === 'login') {
        localStorage.setItem('token', data.token);
        localStorage.setItem('uid', data.userId);
        localStorage.setItem('user', u);
        token = data.token;
        uid = data.userId;

        show('lobby-screen');
        document.getElementById('display-user').innerText = u;
        connect();
    } else {
        alert(data.message || data.error);
    }
}

function connect() {
    if (socket) socket.disconnect();
    socket = io({ auth: { token } });

    socket.on('connect', () => emit('obtener_partidas'));

    socket.on('lista_partidas', list => {
        document.getElementById('lista-partidas').innerHTML =
            list.map(g => `
                <div class="game-item">
                    Vs ${g.Jugador1.username}
                    <button onclick="emit('unirse_partida',${g.id})">
                        Unirse
                    </button>
                </div>
            `).join('');
    });

    socket.on('ranking_actualizado', rank => {
        document.getElementById('ranking-body').innerHTML =
            rank.map(r => `
                <tr>
                    <td>${r.user}</td>
                    <td>${r.pct}%</td>
                    <td>${r.wins}/${r.total}</td>
                </tr>
            `).join('');
    });

    socket.on('partida_creada', d =>
        setupGame(d.gameId, d.mensaje, true)
    );

    socket.on('partida_empezada', d => {
        setupGame(d.gameId, '¬°JUGANDO!', false);
        p1Id = d.jugador1Id;
        document.getElementById('oponente-name').innerText = d.oponente;
    });

    socket.on('resultado_ronda', d => {
        const soyP1 = String(uid) === String(p1Id);
        document.getElementById('score-me').innerText =
            soyP1 ? d.marcador.p1 : d.marcador.p2;
        document.getElementById('score-rival').innerText =
            soyP1 ? d.marcador.p2 : d.marcador.p1;
    });

    socket.on('fin_partida', () => {
        document.getElementById('zona-juego').classList.add('hidden');
        document.getElementById('fin-msg').classList.remove('hidden');
    });

    socket.on('partida_terminada', d => {
        alert(d.mensaje);
        location.reload();
    });
}

function emit(ev, data) {
    socket.emit(ev, data);
}

function logout() {
    localStorage.clear();
    location.reload();
}

function show(id) {
    ['auth-screen','lobby-screen','game-screen']
        .forEach(s => document.getElementById(s).classList.add('hidden'));
    document.getElementById(id).classList.remove('hidden');
}

function setupGame(id, msg, waiting) {
    show('game-screen');
    document.getElementById('status-msg').innerText = msg;

    if (waiting) {
        document.getElementById('zona-juego').classList.add('hidden');
        document.getElementById('oponente-name').innerText = 'Esperando...';
    } else {
        document.getElementById('zona-juego').classList.remove('hidden');
    }
}
</script>

</body>
</html>
